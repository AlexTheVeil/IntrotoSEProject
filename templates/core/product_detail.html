{% extends 'core/base.html' %}

{% block content %}
<div class="max-w-4xl mx-auto py-10 px-4">

    <!-- Product Name -->
    <h1 class="text-3xl font-bold mb-4">{{ product.title }}</h1>

    <!-- Product Image Slider -->
    <div id="slider" class="relative w-full h-96 overflow-hidden rounded-lg mb-6">
        {% if product.productimages.all %}
            {% for img in product.productimages.all %}
                <img src="{{ img.images.url }}" alt="{{ product.title }}"
                     class="absolute inset-0 w-full h-full object-cover transition-opacity duration-500 {% if forloop.first %}opacity-100{% else %}opacity-0{% endif %}">
            {% endfor %}
        {% elif product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.title }}"
                 class="w-full h-full object-cover rounded-lg">
        {% else %}
            <div class="w-full h-full bg-gray-200 flex items-center justify-center rounded-lg">
                <span class="text-gray-500">No image available</span>
            </div>
        {% endif %}
    </div>

    <!-- Product Description -->
    <p class="text-gray-700 mb-4">{{ product.description }}</p>
    <p class="text-xl font-semibold mb-6">Price: ${{ product.price }}</p>

    <!-- Quantity Input -->
    <div class="mb-6">
        <label for="product_quantity" class="mr-2 font-medium">Quantity:</label>
        <input type="number" id="product_quantity" value="1" min="1"
               class="w-20 border rounded px-2 py-1">
    </div>

    <!-- Action Buttons -->
    <div class="flex space-x-4">
        <a href="{% url 'core:home' %}"
           class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
            Back to Products
        </a>

        <button id="add-to-cart-btn" data-pid="{{ product.pid }}"
                class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
            Add to Cart
        </button>
    </div>

</div>

<!-- Slider Script -->
<script>
const slider = document.getElementById('slider');
if(slider){
    const slides = slider.children;
    let current = 0;

    setInterval(() => {
        slides[current].classList.remove('opacity-100');
        slides[current].classList.add('opacity-0');
        current = (current + 1) % slides.length;
        slides[current].classList.remove('opacity-0');
        slides[current].classList.add('opacity-100');
    }, 4000);
}
</script>

<!-- AJAX Add-to-Cart Script -->
<script>
// Helper: get CSRF token from cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('add-to-cart-btn');
    const qtyInput = document.getElementById('product_quantity');

    btn.addEventListener('click', function() {
        const pid = this.dataset.pid;
        const qty = qtyInput ? qtyInput.value : 1;

        fetch(`/add-to-cart/${pid}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `qty=${qty}`
        })
        .then(response => {
            if (!response.ok) throw new Error("Network response was not ok");
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Update cart count dynamically
                const cartCountElem = document.getElementById('cart-count');
                if (cartCountElem) cartCountElem.textContent = data.new_cart_count;
                alert(`${data.product_name} added to cart!`);
            } else {
                alert(data.error || "Failed to add item to cart.");
            }
        })
        .catch(error => {
            console.error("Error adding to cart:", error);
            alert("Something went wrong.");
        });
    });
});
</script>
{% endblock %}
